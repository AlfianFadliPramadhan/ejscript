#
#	configure.ejs -- Build configuration script for Embedthis Ejscript
#
#	Copyright (c) Embedthis Software LLC, 2003-2011. All Rights Reserved.
#	This script is included by configure and is never run stand-alone.
#

applyDependencies()
{
    BLD_FEATURE_MPR=1

    if [ "$CFG_WITHOUT_SSL" = 1 ] ; then
        without matrixssl
        without openssl
    fi
}


manageFeatures()
{
    if [ "$BLD_FEATURE_ROMFS" = 1 -a "$BLD_CROSS" = 0 ] ; then
        echo
        echo "ROM-based storage is only supported if doing cross-compilation"
        echo
        exit 255
    fi
    if [ "$BLD_FEATURE_FLOAT" = 0 ] ; then
        echo " "
        echo "Floating point support is required."
        echo "Enabling the floating point support."
        BLD_FEATURE_FLOAT=1
    fi
    if [ "$BLD_FEATURE_AUTH_PAM" = 1 ] ; then
        if [ "$BLD_HOST_OS" = WIN  -o "$BLD_HOST_OS" = VXWORKS ] ; then
            echo " "
            echo "PAM authorization is only support on UNIX."
            BLD_FEATURE_AUTH_PAM=0
            BLD_FEATURE_AUTH_FILE=1
        fi
    fi
    if [ "$BLD_FEATURE_AUTH_PAM" = 0 -a "$BLD_FEATURE_AUTH_FILE" = 0 ] ; then
        echo " "
        echo "Must have one auth backend enabled (PAM or FILE)."
        echo "Enabling the auth-file authorization backend."
        BLD_FEATURE_AUTH_FILE=1
    fi
}


createFeatureConfig()
{
	NAME=$1
	cat >>$NAME <<!EOF_FEATURE_CONFIG1
#
#   Ejscript Feature Selection
#
BLD_EJS_PRODUCT=1
BLD_FEATURE_AUTH_FILE=$BLD_FEATURE_AUTH_FILE
BLD_FEATURE_AUTH_PAM=$BLD_FEATURE_AUTH_PAM

#
#   Test port configuration
#
BLD_HTTP_PORT=$BLD_HTTP_PORT
BLD_SSL_PORT=$BLD_SSL_PORT

#
#   Manager name
#
BLD_MANAGER="ejsman"

#
#   Http program name
#
BLD_HTTP="ehttp"

!EOF_FEATURE_CONFIG1
}


emitExtraComponents()
{
    local kind v

    kind=$1

#     local kind libs ssl ssl_libs v
# 
#     libs="ejs http"
#     eval pcre=\$CFG_${kind}_PCRE
#     eval ssl=\$CFG_${kind}_SSL
#     eval ssl_libs=\$CFG_${kind}_SSL_LIBS
#     if [ "$pcre" = 1 ] ; then
#         libs="$libs pcre"
#     fi
#     if [ "$ssl" = 1 ] ; then
#         libs="$libs ${ssl_libs}"
#     else
#         libs="$libs mpr"
#     fi
# 	echo -e "BLD_EJS_LIBS=\"$libs\""

 	echo -e "#\n#   Ejscript Libraries and Directories\n#"
    eval v=\$BLD_${kind}_JEM_DIR
    echo -e "${t}BLD_JEM_DIR=\"${v}\""
    eval v=\${BLD_${kind}_JEM_DIR}
    v=`eval canonPath "${v}"`
    echo -e "${t}BLD_ABS_JEM_DIR=\"${v}\""
    mkdir -p "${v}"

}


help()
{
	cat <<!EOF_HELP

Additional Ejscript Features:
  --auth=[pam|file]        Build with file or PAM-based http authorization support.
  --port=PORT              Set the HTTP test port.
  --sslPort=PORT           Set the SSL test port.
  
Optional Components: matrixssl, openssl, pcre, sqlite

  --with-NAME=[DIR]        Add support for the NAME. The component file in
                           build/components/NAME will describe compile and 
                           linker switches. DIR is the base directory to 
                           find the module libraries and headers.
  --without-NAME           Do not include support for NAME.

Examples:
  ./configure --with-openssl=/usr/src/openssl

!EOF_HELP
}


parseArg()
{
    local ARG SW lower

	ARG="${1#*=}"
	[ "$ARG" = "$1" ] && ARG=

    SW=`echo ${1#--} | tr '[A-Z]' '[a-z]'`
    lower=`echo ${ARG#--} | tr '[A-Z]' '[a-z]'`
    case ${SW} in
    auth=*)
        if [ "$lower" = "file" ] ; then
            BLD_FEATURE_AUTH_FILE=1
            BLD_FEATURE_AUTH_PAM=0
        elif [ "$lower" = "pam" ] ; then
            BLD_FEATURE_AUTH_FILE=0
            BLD_FEATURE_AUTH_PAM=1
        else
            echo "Unknown authorization backend for --auth"
            exit 255
        fi
        ;;
	disable-all)
        BLD_DISABLE_ALL=1
        BLD_FEATURE_ASSERT=0
        BLD_FEATURE_LEGACY_API=0
        ;;
	enable-all)
        BLD_FEATURE_ASSERT=1
        BLD_FEATURE_LEGACY_API=1
        ;;
    port=*)
        BLD_HTTP_PORT=${ARG}
        ;;
    sslport=*)
        BLD_SSL_PORT=${ARG}
        ;;
	*)	
		return 1
		;;
	esac
	return 0
}

#
#   Only shared builds are supported
#
BLD_NO_STATIC_SUPPORT=1

