<!DOCTYPE html><html lang="en"><head><title>Extending</title><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="Javacript Language Environment"><link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700|Open+Sans:300italic,400,300,700' rel='stylesheet' type='text/css'><link href='https://fonts.googleapis.com/css?family=Julius+Sans+One' rel='stylesheet' type='text/css'><link href="../images/favicon.ico" rel="shortcut icon"><link href="../lib/semantic-ui/semantic.min.css" rel="stylesheet" type="text/css"><link href="../css/all.min.css" rel="stylesheet" type="text/css"><link href="../css/api.min.css" rel="stylesheet" type="text/css"><body class="show-sidebar"><div class="sidebar"><div class="ui large left vertical inverted labeled menu"><div class="item"><a href="../index.html" class="logo">Ejscript Docs</a></div><div class="item"><a href="../index.html"><b>General</b></a><div class="menu"><a class="item" href="../index.html">Ejscript Overview</a> <a class="item" href="../users/features.html">Ejscript Features</a> <a class="item" href="https://embedthis.com/ejscript/download.html">Download</a> <a class="item" href="../licensing/index.html">Licensing</a></div></div><div class="item"><a href="../start/index.html"><b>Getting Started</b></a><div class="menu"><a class="item" href="../start/quick.html">Quick Start</a> <a class="item" href="../start/installing.html">Installing Ejscript</a> <a class="item" href="../start/tour.html">Language Tour</a> <a class="item" href="../start/faq.html">FAQ</a> <a class="item" href="../start/releaseNotes.html">Release Notes</a> <a class="item" href="../start/source.html">Building from Source</a></div></div><div class="item"><a href="../users/index.html"><b>User's Guide</b></a><div class="menu"><a class="item" href="../users/shell.html">Using the Command Shell</a> <a class="item" href="../users/compiler.html">Using the Compiler</a> <a class="item" href="../users/ejsmod.html">Using the Module Generator</a> <a class="item" href="../users/doc.html">Generating Documentation</a> <a class="item" href="../users/listing.html">Generating Listing</a> <a class="item" href="../users/man.html">Man Pages</a></div></div><div class="item"><a href="../language/index.html"><b>Language Guide</b></a><div class="menu"><a class="item" href="../language/syntax.html">Language Syntax</a> <a class="item" href="../language/statements.html">Statements</a> <a class="item" href="../language/expressions.html">Expressions and Operators</a> <a class="item" href="../language/objects.html">Object and Arrays</a> <a class="item" href="../language/functions.html">Functions and Methods</a> <a class="item" href="../language/core.html">Core Language Types</a> <a class="item" href="../language/types.html">Types and Declarations</a> <a class="item" href="../language/classes.html">Classes and Instances</a> <a class="item" href="../language/modules.html">Modules and Namespaces</a> <a class="item" href="../language/library.html">System Library</a> <a class="item" href="../language/events.html">Events and Timers</a> <a class="item" href="../language/modes.html">Language Modes</a> <a class="item" href="../language/globals.html">Globals</a></div></div><div class="item"><a href="../web/index.html"><b>Web Framework Guide</b></a><div class="menu"><a class="item" href="../web/webTour.html">Web Framework Tour</a> <a class="item" href="../web/generator.html">Application Generator</a> <a class="item" href="../web/routing.html">Routing</a> <a class="item" href="../web/controllers.html">Controllers</a> <a class="item" href="../web/views.html">Views and Layout Templates</a> <a class="item" href="../web/controls.html">Ajax View Controls</a> <a class="item" href="../web/models.html">Database Models</a> <a class="item" href="../web/hosting.html">Hosting in Web Servers</a></div></div><div class="item"><a href="../developers/index.html">Developer's Guide</a><div class="menu"><a class="item" href="../developers/embedding.html">Embedding Ejscript</a> <a class="item" href="../developers/extending.html">Extending Ejscript</a></div></div><div class="item"><a href="../ref/index.html">Reference Guide</a><div class="menu"><a class="item" href="../ref/compatibility.html">Compatibility</a> <a class="item" href="../ref/native.html">Native APIs</a> <a class="item" href="../ref/api/ejscript/index.html" target="new">Script Library</a> <a class="item" href="../ref/architecture.html">Ejscript Architecture</a> <a class="item" href="../ref/webArchitecture.html">Web Framework Architecture</a> <a class="item" href="../ref/memory.html">Ejscript Memory Allocation</a> <a class="item" href="../ref/multithread.html">Multithreaded Programming</a> <a class="item" href="../standards/references.html">Standards</a></div></div><div class="item"><a href="../developers/project.html">Project Resources</a><div class="menu"><a class="item" href="http://goo.gl/g4oS2C">Official Ejscript News</a> <a class="item" href="https://embedthis.com/ejscript/">Ejscript Web Site</a> <a class="item" href="https://github.com/embedthis/ejs">Source Code Repository</a> <a class="item" href="https://github.com/embedthis/ejs/issues">Project Issue Database</a> <a class="item" href="https://github.com/embedthis/ejs/releases">Change Log</a> <a class="item" href="https://github.com/embedthis/ejs/milestones">Roadmap</a> <a class="item" href="https://embedthis.com/developers/contributors.html">Contributors Agreement</a></div></div><div class="item"><b>Links</b><div class="menu"><a class="item" href="https://embedthis.com/">Embedthis Web Site</a> <a class="item" href="https://embedthis.com/blog/">Embedthis Blog</a> <a class="item" href="http://twitter.com/mobstream">Twitter</a></div></div></div></div><div class="ui inverted masthead"><div class="ui fixed inverted menu"><div class="ui sidebar-launch button"><i class="icon list layout"></i></div><div class="right menu"><a class="item" href="https://embedthis.com/">Embedthis</a> <a class="item" href="https://embedthis.com/ejscript/">Ejscript Site</a> <span class="desktop-only"><a class="item" href="http://goo.gl/dGRDl4">Ejscript News</a> <a class="item" href="https://github.com/embedthis/ejs">Repository</a> <a class="item" href="https://embedthis.com/blog/">Blog</a> <a class="item" href="https://twitter.com/mobstream">Twitter</a></span></div></div><div class="ui breadcrumb"><a class="section" href="../">Home</a><div class="divider">/</div><a class="section" href="index.html">Developer's Guide</a><div class="divider">/</div><a class="active section" href="extending.html">Extending</a></div><iframe class="version desktop-only" src="../version.html"></iframe></div><div class="content"><h1>Extending Ejscript</h1><p>Ejscript can be extended to create new types, functions, objects and variables.</p><p>Ejscript may be extended ways:</p><ul><li>Creating <a href="#script">script library modules</a> &mdash; Standard script code modules</li><li>Creating <a href="#native">native modules</a> &mdash; C Language loadable type modules</li></ul><p>Scripting is certainly quicker, easier and more secure than creating native C modules. However, Native C coding may run faster and gives you access to the full Ejscript Virtual Machine.</p><a id="script"></a><h2>Script Library Modules</h2><p>Script code can be compiled and the byte code saved for use by other users as a module file. When script code is compiled, the Ejscript <b>ejsc</b> compiler saves the output in a module file with a <b>.mod</b> extension. This is often referred to as a <b>mod</b> file.</p><pre class="ui code segment">
ejsc --out Library.mod file1.es file2.es
</pre><p>This example creates a pre-compiled mod file with the byte code for file1 and file2. It can be reused by other script programs without having to parse or recompile the script files. The <b>ejs</b> shell and the <b>ejsc</b> compiler accept mod files on the command line. For example:</p><pre class="ui code segment">
ejs Library.mod program.es
</pre><p>This loads the Library module and then runs the program.es script. It would be nice not to have to explicitly specify the required modules on the command line. The module directive solves this problem. In-fact, this is what the Ejscript core libraries do to transparently load the various ejs.* modules that comprise the Ejscript core language library.</p><h3>Module Directives</h3>The <b>module</b> directive is an Ejscript statement that groups related declarations into a single logical module. Module directives are similar to ActionScript or Java packages.<pre class="ui code segment">
/* In the source file anyname.es */
module mytools {
    /* Put any declarations here */
    function myFunction() {
    }
}
</pre><p>This example creates a function called <b>myFunction</b> which is included in the <b>mytools</b> module. When compiled by <b>ejsc</b>, this will create a module file with the same name as the module directive name.</p><p>If we put the above script code into a source file called anyname.es, and then compile with <b>ejsc</b>, we will get a module file called <b>mytools.mod</b>.</p><pre class="ui code segment">
ejsc anyname.es
ls -l mytools*
<b>-rw-r--r--  1 john  wheel  78 Feb 19 19:38 mytools.mod</b>
</pre><p>If the compiler is invoked without the --out switch, it will automatically create module files corresponding to each module directive. Note that module blocks may span several files and that the ejsc compiler will aggregate the code from each source file into the correct module file.</p><p>When compiled, the module can be used in another program and be brought into scope via the <b>use module</b> directive.</p><pre class="ui code segment">
/* In the source file program.es */
require testlib
myFunction()
</pre><p>To run the program with the <b>ejs</b> shell you now do not need to specify the module name. The compiler and loader will automatically resolve and load the mytools.mod module file in response to the <b>use module</b> directive.</p><pre class="ui code segment">
ejs program.es
</pre><h3>Installing Modules</h3><p>Once your module is created, you can install it by simply copying it to the Ejscript module repository. On Unix systems, the repository is typically at /usr/lib/ejscript/modules. You should observe the <a href=../language/modules.html#repository>Ejscript Module Repository</a> guidelines when you install your module.</p><p>By using module directives, you can simply create a modular extension components and libraries for Ejscript that can be easily used by others. For more information, read the <a href=../language/modules.html>Modules and Namespaces</a> and <a href=../language/classes.html>Classes</a> documents.</p><h3>Declarations</h3><p>You can define global functions and variables by placing such declarations outside any module blocks. Then by using the ejsc compiler <b>--out</b> switch, you can explicitly name the output module file. However, module files that contain only global code with no module directives will need to be explicitly loaded and cannot be installed in the module repository. Without a module directive, the loader cannot locate the module. Users of such a module will need to explicitly load the module. A solution is to create a dummy module directive purely to give the module a name.</p><a id="native"></a><h2>Native Modules</h2><p>Native modules are Ejscript modules that have their implementation provided by native C code rather than by compiled byte code. Native modules have full access to the Ejscript Virtual Machine. If you need maximum control, then creating native modules is probably the way to go.</p><h3>Steps to Create a Native Module</h3><ol><li>Create a module interface</li><li>Generate the module C header</li><li>Create the native C code for the module</li><li>Compile into a shared or static library</li></ol><h3>Module Interface</h3><p>Defining and specifying traits of all module declarations in C can be tedious. You need to specify the names, types and qualifiers for all types, functions, function parameters, return types and variable. However, there is an easier way.</p><p>By creating a scripted module interface file and compiling this into a mod file, you are relieved of completing this task in C. The module interface is compiled like any other script to generate a mod file. When a program requests to load the module, the loader will first load the interface mod file and then load the module shared library.</p><p>A module interface file looks like a normal script file except that declarations are decorated by <b>native</b> qualifier, functions do not have code bodies or braces and all variables, functions and parameters are typically fully typed using <a href="../language/types.html#typeAnnotations">type annotations</a>.</p><pre class="ui code segment">
use strict
module acme {
    native var launchAttempts: Number
    native function createRocket(kind: String): Rocket
    native class Rocket {
        private var kind: String
        private var timeToOrbit: Number
        native function Rocket()
        native function blastOff(kind: String): Void
    }
}
</pre><p>There are several things to explain in this example. We put the compiler into strict mode to warn if we omit the type of any variable, function parameter and or return value.</p><h4>Blended Modules</h4><p>The module interface can blend native code and script code. i.e. It can contain actual script code without a <b>native</b> qualifier. In this way, you can choose on a function by function basis whether a function is best implemented as script code or as native C code.</p><h3>Generate the Module C header</h3><p>After compiling the module interface into a mod file, we can generate a C header that describes the locations of the declarations in the VM. Where possible, the Ejscript compiler early-binds declarations into slot offsets which are property indices into the relevant objects. Early binding enhances the speed and quality of the generated byte code. For example, variables can often be accessed by numerical slot offset rather than doing a costly run-time lookup by name through the scope chain.</p><p>The <b>ejsmod</b> module manager tool is used to generate the C header.</p><pre class="ui code segment">
ejsmod --cslots acme.mod
</pre><p>This creates a <b>acme.slots.h</b> C language header file that should be included by that module native C code. You can use the slot definitions with the Ejscript APIs like <b>ejsGetProperty</b> which will take the symbolic slot offset as an argument.</p><p>The header contains definitions like:</p><pre class="ui code segment">
/**
     Class property slots for the "Rocket" class
  */
#define ES_acme_Rocket__origin             5
#define ES_acme_Rocket_Rocket              5
#define ES_acme_Rocket_blastOff            6
#define ES_acme_Rocket_NUM_CLASS_PROP      7
/**
   Instance slots for "Rocket" type
  */
#define ES_acme_Rocket_kind                0
#define ES_acme_Rocket_timeToOrbit         1
#define ES_acme_Rocket_NUM_INSTANCE_PROP   2
/**
      Local slots for methods in type Rocket
 */
#define ES_acme_Rocket_blastOff_kind       0
</pre><p>The defines follow the form: ES_module_class_function_declaration. Where class and function are omitted for declarations outside classes or functions.</p><h3>Creating the Module Native C Code</h3><p>When Ejscript loads the module interface file, it creates and configures objects for all the declarations in the interface. All that remains to be done is create the native code implementation for the C functions and bind them to the defined JavaScript functions.</p><p>But first we need to create a loadable module if we are building shared.</p><h4>Create the Loadable Module</h4><p>The loadable module is a shared library containing the native class implementation and a library entry point function. The function must be named MODULE_ModuleInit, where MODULE is the name of your module with all dots changed to underscores.</p><pre class="ui code segment">
#include "ejs/ejs.h"
#include "acme.slots.h"
int acmeModuleInit(Ejs *ejs, MprModule *module)
{
    EjsType     *type;
    EjsName     qname;
    /* Get the Rocket class object */
    type = ejsGetTypeByName(ejs, ejsName(ejs, "acme", "Shape"));
    /* Bind the C functions to the JavaScript functions */
    ejsBindConstructor(ejs, type, constructor);
    ejsBindMethod(ejs, type-&gt;prototype, ES_acme_Rocket_blastOff, blastOff);
    return module;
}
</pre><p>This entry point will be invoked after the Ejscript loader loads the mod file and the shared library.</p><p>The module object created by mprCreateModule is used by the MPR runtime to manage the module. The "rocket" name does not really matter. Just provide reasonably descriptive name for the module library.</p><p>The Rocket type has already been created via the mod file and so we can just get it as a property of the global object. All types are stored as global properties.</p><p>Lastly, we can call <b>ejsBindMethod</b> to bind the C function implementations to the JavaScript functions. In this case, we bind the constructor function and the blastOff function.</p><h4>Create the Native C functions</h4><pre class="ui code segment">
static EjsObj *constructor(Ejs *ejs, EjsObj *rocket, int argc, EjsObj **argv)
{
    ejsSetProperty(ejs, rocket, ES_acme_Rocket_kind, argv[0]);
    return rocket;
}
static EjsObj *blastOff(Ejs *ejs, EjsObj *rocket, int argc, EjsObj **argv)
{
    ejsSetProperty(ejs, rocket, ES_acme_Rocket_timeToOrbit, 
        ejsCreateNumber(ejs, 600));
    return 0;
}
</pre><h3>Things to Remember</h3><p>By creating a module interface definition, the VM is able to check and cast all function arguments to the correct type. This greatly simplifies writing native functions &mdash; you don't need to check type number or types of the arguments.</p><p>For each function, think if it should be created in script code or in native code. You can often code functions that are not executed as frequently in script code without impacting performance. It is a good strategy to prototype the module in script first and then convert the prototype to native code on a function-by-function basis.</p><a id="api"></a><h2>Native API</h2><p>Ejscript has an extensive native API for interacting with the Ejscript virtual machine. Because types are themselves objects, the API offers a consistent way to access properties from objects or classes. Some of the more important API functions are listed below. See the full <a href="../ref/api/ejscript.html">Ejscript API</a> and the <a href="../ref/api/mpr.html">MPR API</a> reference for full details.</p><table title="details" class="ui table segment"><thead><tr><th>API Name<th>API Description<tbody><tr><td>ejsAlloc<td>Allocate a new object instance<tr><td>ejsBindMethod<td>Bind a native C function to a JavaScript property<tr><td>ejsCast<td>Cast a variable to another type<tr><td>ejsClone<td>Create a clone copy of a variable<tr><td>ejsCreateArray<td>Create a new array<tr><td>ejsCreateBareString<td>Create an empty string of the required length<tr><td>ejsCreateBoolean<td>Create a Boolean value<tr><td>ejsCreateByteArray<td>Create a ByteArray object<tr><td>ejsCreateDate<td>Create a Date object<tr><td>ejsCreateFile<td>Create a File object<tr><td>ejsCreateFunction<td>Create a Function object<tr><td>ejsCreateIterator<td>Create an Iterator object<tr><td>ejsCreateNumber<td>Create a Number object<tr><td>ejsCreateObject<td>Create an object and reserve space for properties<tr><td>ejsCreateRegExp<td>Create a RegExp (regular expression) object<tr><td>ejsCreateSimpleObject<td>Create a simple, empty object<tr><td>ejsDefineGlobalFunction<td>Define a public global function and bind to a C function<tr><td>ejsDeleteProperty<td>Delete a property from an object<tr><td>ejsDeserialize<td>Deserialize a string and create an equivalent object<tr><td>ejsExit<td>Exit the application<tr><td>ejsGetBoolean<td>Get a native boolean value from a Boolean object<tr><td>ejsGetInt<td>Get a native integer value from a Number object<tr><td>ejsGetNumber<td>Get a native number from a Number object<tr><td>ejsGetProperty<td>Get a property from an object<tr><td>ejsGetVarType<td>Get the underlying type of a variable<tr><td>ejsGetDouble<td>Get a native double value from a Number object<tr><td>ejsGrowObject<td>Grow the space allocated for properties in an object<tr><td>ejsIsA<td>Determine if an object is of a given type<tr><td>ejsLookupProperty<td>Lookup a property by name in an object<tr><td>ejsParseVar<td>Parse a string and create an equivalent variable<tr><td>ejsRun<td>Run a script<tr><td>ejsRunFunction<td>Run a function<tr><td>ejsRunFunctionBySlot<td>Run a function at a given property slot<tr><td>ejsSerialize<td>Serialize an object into an equivalent string representation<tr><td>ejsSetProperty<td>Set a property's value<tr><td>ejsSetPropertyByName<td>Set a property's value using the property name<tr><td>ejsSetPropertyName<td>Update the property's name<tr><td>ejsThrowError<td>Throw an error exception<tr><td>ejsToString<td>Convert (cast) the argument to a string</table><h2>Samples</h2><p>A library of samples is provided with the Ejscript source code. See the samples directory for many examples of embedding and extending Ejscript.</p><p>For information about embedding Ejscript into applications, see the <a href="embedding.html">Embedding Ejscript</a></p><a href="embedding.html">document</a>.</div><div class="terms ui basic center aligned segment"><p>&copy; Embedthis Software, 2003-2015. All rights reserved.</p></div><script src="../lib/jquery/jquery.min.js"></script><script src="../lib/semantic-ui/semantic.min.js"></script><script src="../scripts/sidebar.min.js"></script>